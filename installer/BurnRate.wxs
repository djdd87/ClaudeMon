<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package
    Name="BurnRate"
    Manufacturer="BurnRate"
    Version="$(var.Version)"
    UpgradeCode="7A3B8C1D-4E5F-6A7B-8C9D-0E1F2A3B4C5D">

    <MajorUpgrade
      DowngradeErrorMessage="A newer version of BurnRate is already installed." />

    <MediaTemplate EmbedCab="yes" />

    <StandardDirectory Id="ProgramFiles6432Folder">
      <Directory Id="INSTALLFOLDER" Name="BurnRate">
        <!-- Optional: add BurnRate to Windows startup -->
        <Component Id="AutoStart" Guid="3C4D5E6F-7A8B-9C0D-1E2F-3A4B5C6D7E8F">
          <RegistryValue
            Root="HKCU"
            Key="SOFTWARE\Microsoft\Windows\CurrentVersion\Run"
            Name="BurnRate"
            Type="string"
            Value="[INSTALLFOLDER]BurnRate.exe"
            KeyPath="yes" />
        </Component>
      </Directory>
    </StandardDirectory>

    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="BurnRate">
        <Component Id="StartMenuShortcut" Guid="4D5E6F7A-8B9C-0D1E-2F3A-4B5C6D7E8F9A">
          <Shortcut
            Id="ApplicationStartMenuShortcut"
            Name="BurnRate"
            Description="Claude Code Usage Monitor"
            Target="[INSTALLFOLDER]BurnRate.exe"
            WorkingDirectory="INSTALLFOLDER" />
          <RemoveFolder Id="CleanUpShortcut" On="uninstall" />
          <RegistryValue
            Root="HKCU"
            Key="SOFTWARE\BurnRate"
            Name="StartMenuShortcut"
            Type="integer"
            Value="1"
            KeyPath="yes" />
        </Component>
      </Directory>
    </StandardDirectory>

    <!-- Include all files from the publish directory so native WPF DLLs
         (wpfgfx_cor3.dll, PresentationNative_cor3.dll, D3DCompiler_47_cor3.dll, etc.)
         are installed alongside the exe. PublishSingleFile leaves these as loose files. -->
    <ComponentGroup Id="PublishFiles" Directory="INSTALLFOLDER" Source="$(var.PublishDir)" />

    <!-- Required: application files and start menu shortcut -->
    <Feature Id="Main" Title="BurnRate" Level="1"
             Description="The BurnRate system tray application and Start Menu shortcut.">
      <ComponentGroupRef Id="PublishFiles" />
      <ComponentRef Id="StartMenuShortcut" />
    </Feature>

    <!-- Optional: register BurnRate to launch automatically at Windows login -->
    <Feature Id="StartupLaunch" Title="Start with Windows" Level="1"
             Description="Automatically start BurnRate when you log in to Windows.">
      <ComponentRef Id="AutoStart" />
    </Feature>

    <!-- Exit dialog: offer to launch BurnRate immediately after install completes.
         Scheduled in InstallUISequence with OnExit="success" so the action fires
         after the user clicks Finish â€” meaning the checkbox state is respected. -->
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOX" Value="1" />
    <Property Id="WIXUI_EXITDIALOGOPTIONALCHECKBOXTEXT" Value="Launch BurnRate" />
    <Property Id="WixShellExecTarget" Value="[INSTALLFOLDER]BurnRate.exe" />

    <CustomAction Id="LaunchBurnRate"
      BinaryRef="Wix4UtilCA_X64"
      DllEntry="WixShellExec"
      Impersonate="yes"
      Execute="immediate"
      Return="ignore" />

    <!-- Run in UI sequence so the action fires after the user clicks Finish
         (after WIXUI_EXITDIALOGOPTIONALCHECKBOX reflects their final choice). -->
    <InstallUISequence>
      <Custom Action="LaunchBurnRate" OnExit="success"
              Condition="WIXUI_EXITDIALOGOPTIONALCHECKBOX = 1 AND NOT Installed" />
    </InstallUISequence>

    <!-- Wizard: shows license, feature tree (with "Start with Windows" toggle),
         install directory browser, progress, and exit dialog with launch checkbox. -->
    <ui:WixUI Id="WixUI_FeatureTree" InstallDirectory="INSTALLFOLDER" />
    <WixVariable Id="WixUILicenseRtf" Value="License.rtf" />
  </Package>
</Wix>
